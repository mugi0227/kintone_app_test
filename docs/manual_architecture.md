# システム構造と安全性の解説

このドキュメントでは、本アプリケーション（キャリアアンカー診断）がどのような仕組みで動作しているか、およびその安全性について解説します。
技術的な専門知識がない方でも理解できるように、図解とコードの役割説明を用いて説明します。

## 1. 全体像：データの流れ

このシステムは、3つのサービスが連携して動作しています。

```mermaid
graph LR
    User[利用者] -- 1. 回答 --> FB[FormBridge<br>(診断フォーム)]
    FB -- 2. データ保存 --> Kintone[kintone<br>(データベース)]
    Kintone -- 3. データ参照 --> KV[kViewer<br>(結果閲覧)]
    KV -- 4. 結果表示 --> User
```

1.  **FormBridge**: 利用者が質問に回答する「入力画面」です。
2.  **kintone**: 回答データを安全に保管する「金庫」です。
3.  **kViewer**: 保存されたデータを分析し、グラフやスコアとして見やすく表示する「閲覧画面」です。

---

## 2. プログラム（JavaScript）の詳細解説

本システムで使用しているプログラム（`customize.js`）は、**「計算」と「表示」のみ**を行っています。
外部へのデータ送信や、不正な操作を行うコードは一切含まれていません。
以下に、プログラムが何をしているかを機能ごとに解説します。

### A. FormBridge用プログラム (`formbridge/js/customize.js`)

| 機能ブロック | 何をしているか | 安全性の証明 |
| :--- | :--- | :--- |
| **質問の表示** | 40問の質問文と回答ボタン（1～5）を画面に並べます。 | 単にHTMLを表示しているだけです。 |
| **ページ切り替え** | 「次へ」「戻る」ボタンを押したときに、前の質問を隠して次の質問を表示します。 | 画面の表示/非表示を切り替えているだけです。 |
| **スコア計算** | 回答（1～5の数値）を足し算して、8つのキャリアタイプごとの合計点を算出します。 | ブラウザ内で完結する単純な計算処理です。 |
| **データ保存** | 計算したスコアを、kintoneの保存用フィールド（`score_tf`など）にセットします。 | FormBridgeの正規の機能を使って値をセットしています。 |

### B. kViewer用プログラム (`kviewer/customize.js`)

| 機能ブロック | 何をしているか | 安全性の証明 |
| :--- | :--- | :--- |
| **データの取得** | kintoneに保存されたスコアデータ（`score_tf`など）を読み取ります。 | kViewerが正規に取得したデータを参照しているだけです。 |
| **グラフ描画** | 読み取ったスコアを元に、Chart.jsというライブラリを使ってレーダーチャートを描きます。 | 数値をグラフの絵に変換しているだけです。 |
| **結果表示** | 最も点数の高かったキャリアタイプを判定し、その解説文（「専門・職能別」など）を表示します。 | 定義された文章を表示しているだけです。 |
| **警告表示** | 必要なデータが足りない場合に、「設定エラー」という赤いメッセージを表示します。 | トラブル時に管理者が気づけるようにするための親切機能です。 |

---

## 3. 「DOM操作」とは？（懸念点への回答）

事務局の方が懸念されている「DOM操作」について解説します。

### DOM操作のイメージ
Webページは「積み木」のように部品（DOM）が組み合わさってできています。
今回のカスタマイズでは、この積み木に対して以下のような操作を行っています。

-   **安全な操作**: 「『次へ』ボタンの色を変える」「診断結果の数字を読み取って、グラフの絵を追加する」
-   **やっていない操作**: 「『保存』ボタンを勝手に押す」「パスワード入力欄を勝手に作る」

### リスクと対策
kintoneやトヨクモ製品のアップデート（仕様変更）により、積み木の「名前（IDやクラス名）」が変わることがあります。
これが「DOM操作のリスク」です。名前が変わると、プログラムが部品を見つけられなくなり、**「グラフが表示されない」「ボタンの色が戻る」**といった不具合が起きます。

**ただし、これによってデータが消えたり、セキュリティに穴が開いたりすることはありません。**
あくまで「見た目が崩れる」「便利機能が動かなくなる」という範囲の影響にとどまります。

---

## 4. 安全性の確認方法（ブラックボックスの解消）

本アプリケーションのコードが「安全である（毒性がない）」ことを、誰でも確認できる方法を提示します。

1.  **外部通信のチェック**:
    *   コード内（`customize.js`）を「fetch」や「XMLHttpRequest」という単語で検索してください。
    *   これらは外部と通信するための命令ですが、本コードには含まれていません（Chart.jsの読み込みを除く）。
    *   つまり、**データを外部に持ち出す機能自体が存在しません。**

2.  **入力値の操作チェック**:
    *   コード内で `innerHTML` という命令を使っていますが、ここに埋め込んでいるのは「固定の質問文」や「計算された数値」だけです。
    *   ユーザーが自由に入力したテキストをそのまま埋め込む処理はないため、XSS（クロスサイトスクリプティング）という攻撃を受けるリスクもありません。
